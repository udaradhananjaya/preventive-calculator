<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, .bg-light, .card, .table, .form-control, .form-select, .modal-content {
      background-color: #181a1b !important;
      color: #e0e0e0 !important;
    }
    .card-header, .table-light, .table-summary th {
      background-color: #23272b !important;
      color: #e0e0e0 !important;
    }
    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: #23272b !important;
    }
    .table-striped > tbody > tr:nth-of-type(even) {
      background-color: #181a1b !important;
    }
    .form-label {
      color: #e0e0e0 !important;
    }

    .chart-container { min-height: 350px; }
    .table-summary th, .table-summary td { vertical-align: middle; }
    select.form-select, input.form-control {
      background-color: #23272b !important;
      color: #e0e0e0 !important;
      border-color: #343a40 !important;
    }
    select.form-select:focus, input.form-control:focus {
      background-color: #23272b !important;
      color: #fff !important;
      border-color: #0d6efd !important;
    }
  </style>
</head>
<body class="bg-dark">
  <div class="container py-4">
    <h2 class="mb-4">Task & Student Report</h2>
    <form id="filterForm" class="row g-3 mb-4">
      <div class="col-md-3">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" id="startDate" name="startDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" id="endDate" name="endDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="studentSelect" class="form-label">Student</label>
        <select id="studentSelect" name="studentId" class="form-select">
          <option value="">All Students</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="reset" class="btn btn-warning w-100">Rest Filters</button>
      </div>
    </form>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">Tasks Created Per Day</div>
          <div class="card-body chart-container">
            <canvas id="calendarChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">Tasks Completed Per Day</div>
          <div class="card-body chart-container">
            <canvas id="completedChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-12">
        <div class="card shadow-sm">
          <div class="card-header">Task Load Prediction (Moving Average)</div>
          <div class="card-body chart-container">
            <canvas id="predictionChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #23272b !important; color: #e0e0e0 !important;">
        <span>Per-Student Summary</span>
        <div>
          <button id="exportCSV" class="btn btn-outline-secondary btn-sm me-2">Export CSV</button>
          <button id="exportPDF" class="btn btn-outline-secondary btn-sm">Export PDF</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-striped table-summary mb-0">
            <thead class="table-light">
              <tr>
                <th>Student</th>
                <th>Total Tasks</th>
                <th>Completed</th>
                <th>Pending</th>
                <th>Total Credits</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Assume window.api provides backend bridge (Electron preload)
    let reportData = null;

    async function loadStudents() {
      const students = await window.api.getStudents();
      const select = document.getElementById('studentSelect');
      students.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        select.appendChild(opt);
      });
    }

    function renderTable(stats) {
      const tbody = document.getElementById('summaryTableBody');
      tbody.innerHTML = '';
      stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.total}</td>
          <td>${s.completed}</td>
          <td>${s.pending}</td>
          <td>${s.credits.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    let calendarChart, completedChart, predictionChart;

    function renderCharts(data) {
      // Chart.js dark mode options
      const darkGrid = { color: '#444' };
      const darkTicks = { color: '#e0e0e0' };
      // Calendar Chart
      const calendarLabels = Object.keys(data.calendar).sort();
      const calendarCounts = calendarLabels.map(d => data.calendar[d]);
      if (calendarChart) calendarChart.destroy();
      calendarChart = new Chart(document.getElementById('calendarChart'), {
        type: 'bar',
        data: {
          labels: calendarLabels,
          datasets: [{ label: 'Tasks Created', data: calendarCounts, backgroundColor: '#0d6efd' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: darkGrid, ticks: darkTicks },
            y: { grid: darkGrid, ticks: darkTicks }
          }
        }
      });

      // Completed Chart
      const completedLabels = Object.keys(data.completedPerDay).sort();
      const completedCounts = completedLabels.map(d => data.completedPerDay[d]);
      if (completedChart) completedChart.destroy();
      completedChart = new Chart(document.getElementById('completedChart'), {
        type: 'line',
        data: {
          labels: completedLabels,
          datasets: [{
            label: 'Tasks Completed',
            data: completedCounts,
            borderColor: '#198754',
            backgroundColor: 'rgba(25,135,84,0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid: darkGrid, ticks: darkTicks },
            y: {
              grid: darkGrid,
              ticks: {
                ...darkTicks,
                stepSize: 5 // Show increments of 1 (adjust as needed)
              },
              suggestedMax: Math.max(...completedCounts) + 5
            }
          }
        }
      });

      // Prediction Chart
      if (predictionChart) predictionChart.destroy();
      predictionChart = new Chart(document.getElementById('predictionChart'), {
        type: 'line',
        data: {
          labels: data.prediction.dates,
          datasets: [{ label: '7-Day Moving Avg', data: data.prediction.movingAvg, borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.2)', fill: true }]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid: darkGrid, ticks: darkTicks },
            y: { grid: darkGrid, ticks: darkTicks }
          }
        }
      });
    }

    async function loadReport() {
      const form = document.getElementById('filterForm');
      const formData = new FormData(form);
      const filters = {
        startDate: formData.get('startDate') || null,
        endDate: formData.get('endDate') || null,
        studentId: formData.get('studentId') || null,
      };
      reportData = await window.api.getReportData(filters);
      renderCharts(reportData);
      renderTable(reportData.studentStats);
    }

    const filterForm = document.getElementById('filterForm');
    filterForm.addEventListener('submit', async e => {
      e.preventDefault();
      await loadReport();
    });

    // Dynamically update charts when filters change
    ['studentSelect', 'startDate', 'endDate'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', async () => {
          await loadReport();
        });
      }
    });

    document.getElementById('exportCSV').addEventListener('click', async () => {
      await window.api.exportCSV(reportData.studentStats);
      alert('CSV exported!');
    });

    document.getElementById('exportPDF').addEventListener('click', async () => {
      await window.api.exportPDF(reportData.studentStats);
      alert('PDF exported!');
    });

    let defaultStartDate, defaultEndDate;

    // Set default start date to Monday of current week, end date to today
    (function setDefaultDates() {
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0 (Sun) - 6 (Sat)
      const monday = new Date(today);
      // If today is Sunday (0), set Monday to 6 days ago
      monday.setDate(today.getDate() - ((dayOfWeek + 6) % 7));
      const yyyy = monday.getFullYear();
      const mm = String(monday.getMonth() + 1).padStart(2, '0');
      const dd = String(monday.getDate()).padStart(2, '0');
      const mondayStr = `${yyyy}-${mm}-${dd}`;
      const todayStr = today.toISOString().slice(0, 10);

      document.getElementById('startDate').value = mondayStr;
      document.getElementById('endDate').value = todayStr;

      // Store defaults for reset
      defaultStartDate = mondayStr;
      defaultEndDate = todayStr;
    })();

    // Reset filter fields to default values on reset button click
    document.getElementById('filterForm').addEventListener('reset', function (e) {
      // Timeout ensures this runs after the form resets
      setTimeout(() => {
        document.getElementById('startDate').value = defaultStartDate;
        document.getElementById('endDate').value = defaultEndDate;
        document.getElementById('studentSelect').value = "";
        loadReport();
      }, 0);
    });

    // Initial load
    loadStudents().then(loadReport);

    // Navigate to the Add Task window with F1 key
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === 'F1') {
        e.preventDefault();
        window.api.navigateToIndex();
      }
    });

    // Navigate to the All Tasks window with F2 key
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === 'F2') {
        e.preventDefault();
        window.api.navigateToTasks();
      }
    });

    // Navigate to the Students window with F3 key
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === 'F3') {
        e.preventDefault();
        window.api.navigateToStudents();
      }
    });

    // Navigate to the Summary window with F4 key
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === 'F4') {
        e.preventDefault();
        window.api.navigateToSummary();
      }
    });

    //navigate to the Credits window with F9 key
    document.addEventListener("keydown", (e) => {
      const key = e.key;
      if (key === 'F9') {
        e.preventDefault();
        window.api.navigateCredits();
      }
    });
  </script>
</body>
</html>